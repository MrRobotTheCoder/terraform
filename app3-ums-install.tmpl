#!/bin/bash
set -e

# Install Java 11 and wget
sudo dnf install -y java-11-amazon-corretto wget

# Create app directory
mkdir -p /home/ec2-user/app3-usermgmt
cd /home/ec2-user/app3-usermgmt

# Download the WAR file
wget -O usermgmt-webapp.war https://github.com/stacksimplify/temp1/releases/download/1.0.0/usermgmt-webapp.war

# Set environment variables (replace with actual values or use Terraform interpolation)
export DB_HOSTNAME="${rds_db_endpoint}"
export DB_PORT=3306
export DB_NAME=webappdb
export DB_USERNAME=dbadmin
export DB_PASSWORD=dbpassword11

# Start the app on port 8080 and log output
nohup java -jar usermgmt-webapp.war --server.port=8080 > ums-start.log 2>&1 &